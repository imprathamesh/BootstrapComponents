@using System.Globalization
@typeparam TItem

<div class="gantt-chart">
    <div class="gantt-header"
         style="grid-template-columns:var(--row-heading-size) repeat(@TotalMonths, var(--row-column-size));">
        <div class="gantt-header-item"></div>

        @foreach (var month in Months)
        {
            <div class="gantt-header-item">
                @month.ToString("MMM yyyy", CultureInfo.InvariantCulture)
            </div>
        }
    </div>

    <div class="gantt-body"
         style="grid-template-columns:var(--row-heading-size) repeat(@TotalMonths, var(--row-column-size));">

        @foreach (var item in Items)
        {
            <div class="gantt-task-name">
                @TaskName(item)
            </div>

            @for (var i = 0; i < TotalMonths; i++)
            {
                if (i == StartMonthOffset(item))
                {
                    <div class="gantt-task-bar"
                         style="grid-column: span @(MonthDuration(item)); background-color:@BarColor(item)">
                    </div>

                    i += MonthDuration(item) - 1;
                }
                else
                {
                    <div class="gantt-task"></div>
                }
            }
        }
    </div>
</div>
@code {
    [Parameter] public IEnumerable<TItem> Items { get; set; } = new List<TItem>();

    [Parameter] public Func<TItem, string> TaskName { get; set; } = default!;
    [Parameter] public Func<TItem, DateTime> StartDate { get; set; } = default!;
    [Parameter] public Func<TItem, DateTime> EndDate { get; set; } = default!;
    [Parameter] public Func<TItem, string> BarColor { get; set; } = _ => "var(--bs-primary)";

    [Parameter] public DateTime TimelineStart { get; set; }
    [Parameter] public DateTime TimelineEnd { get; set; }

    private List<DateTime> Months = new();

    int TotalMonths => Months.Count;

    protected override void OnParametersSet()
    {
        Months = BuildMonths(TimelineStart.Date, TimelineEnd.Date);
    }

    private static List<DateTime> BuildMonths(DateTime start, DateTime end)
    {
        var months = new List<DateTime>();
        var current = new DateTime(start.Year, start.Month, 1);

        while (current <= end)
        {
            months.Add(current);
            current = current.AddMonths(1);
        }

        return months;
    }

    private int StartMonthOffset(TItem item)
    {
        var start = StartDate(item).Date;
        return Months.FindIndex(m =>
            start.Year == m.Year && start.Month == m.Month);
    }

    private int MonthDuration(TItem item)
    {
        var start = StartDate(item).Date;
        var end = EndDate(item).Date;

        var startIndex = Months.FindIndex(m =>
            m.Year == start.Year && m.Month == start.Month);

        var endIndex = Months.FindIndex(m =>
            m.Year == end.Year && m.Month == end.Month);

        return Math.Max(1, endIndex - startIndex + 1);
    }
}
